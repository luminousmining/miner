name: Linux Boost Build

on:
  workflow_dispatch:
    inputs:
      boost_version:
        description: "Boost version"
        required: true
        default: "1.86.0"

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    env:
      BOOST_VERSION: ${{ github.event.inputs.boost_version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ===============================
      # Prepare variables
      # ===============================
      - name: Prepare Boost variables
        run: |
          BOOST_VERSION_UNDERSCORE=$(echo "${BOOST_VERSION}" | tr '.' '_')
          echo "BOOST_VERSION_UNDERSCORE=$BOOST_VERSION_UNDERSCORE" >> $GITHUB_ENV

      # ===============================
      # Restore Boost cache
      # ===============================
      - name: Restore Boost cache
        id: boost-cache
        uses: actions/cache@v4
        with:
          path: boost-install
          key: boost-${{ runner.os }}-${{ env.BOOST_VERSION }}

      # ===============================
      # Install dependencies
      # ===============================
      - name: Install build dependencies
        if: steps.boost-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget tar

      # ===============================
      # Download Boost
      # ===============================
      - name: Download Boost
        if: steps.boost-cache.outputs.cache-hit != 'true'
        run: |
          wget https://archives.boost.io/release/${BOOST_VERSION}/source/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz
          tar -xzf boost_${BOOST_VERSION_UNDERSCORE}.tar.gz

      # ===============================
      # Build Boost
      # ===============================
      - name: Build Boost
        if: steps.boost-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          cd boost_${BOOST_VERSION_UNDERSCORE}

          ./bootstrap.sh --prefix=${{ github.workspace }}/boost-install

          ./b2 release -j$(nproc)
          ./b2 install

      # ===============================
      # Verify installation
      # ===============================
      - name: Verify Boost
        run: |
          ls -la boost-install/lib

      # ===============================
      # Upload artifact (only if built)
      # ===============================
      - name: Upload Boost artifact
        if: steps.boost-cache.outputs.cache-hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: boost-${{ env.BOOST_VERSION }}
          path: boost-install

name: Build LuminousMiner

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    #==========================================================================
    # INSTALL BASE TOOLS
    #==========================================================================

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libstdc++-12-dev \
          cppcheck \
          checkinstall \
          clang-15 \
          clang++-15 \
          wget \
          git \
          ocl-icd-opencl-dev \
          opencl-headers \
          libgnutls28-dev
        
        # Clean apt cache
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*

    - name: Install CMake 3.26.4
      run: |
        wget --no-check-certificate https://github.com/Kitware/CMake/releases/download/v3.26.4/cmake-3.26.4-linux-x86_64.sh
        sudo sh cmake-3.26.4-linux-x86_64.sh --skip-license --prefix=/usr/local
        cmake --version
        
        # Clean downloaded file
        rm -f cmake-3.26.4-linux-x86_64.sh

    #==========================================================================
    # CACHE SYSTEM
    #==========================================================================

    - name: Cache CUDA 13.1
      id: cache-cuda
      uses: actions/cache@v4
      with:
        path: /usr/local/cuda-13.1
        key: cuda-13.1-ubuntu-22.04-v2

    - name: Cache OpenSSL 1.1.1
      id: cache-openssl
      uses: actions/cache@v4
      with:
        path: /usr/local/ssl
        key: openssl-1.1.1-ubuntu-22.04-v2

    - name: Cache Boost 1.86.0
      id: cache-boost
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/include/boost
          /usr/local/lib/libboost_*
        key: boost-1.86.0-ubuntu-22.04-static-v2

    - name: Cache OpenCL 3.0.17
      id: cache-opencl
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/include/CL
          /usr/local/lib/libOpenCL.so*
        key: opencl-3.0.17-ubuntu-22.04-v2

    #==========================================================================
    # CUDA 13.1 INSTALLATION
    #==========================================================================

    - name: Install CUDA 13.1
      if: steps.cache-cuda.outputs.cache-hit != 'true'
      run: |
        # Download CUDA repository pin file
        wget --no-check-certificate https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin
        sudo mv cuda-ubuntu2204.pin /etc/apt/preferences.d/cuda-repository-pin-600

        # Download CUDA local installer
        wget --no-check-certificate https://developer.download.nvidia.com/compute/cuda/13.1.0/local_installers/cuda-repo-ubuntu2204-13-1-local_13.1.0-590.44.01-1_amd64.deb

        # Install CUDA repository
        sudo dpkg -i cuda-repo-ubuntu2204-13-1-local_13.1.0-590.44.01-1_amd64.deb
        sudo cp /var/cuda-repo-ubuntu2204-13-1-local/cuda-*-keyring.gpg /usr/share/keyrings/

        # Update and install CUDA toolkit
        sudo apt-get update
        sudo apt-get -y install cuda-toolkit-13-1

        # CLEAN UP CUDA FILES
        echo "ðŸ§¹ Cleaning up CUDA installation files..."
        rm -f cuda-repo-ubuntu2204-13-1-local_13.1.0-590.44.01-1_amd64.deb
        sudo rm -rf /var/cuda-repo-ubuntu2204-13-1-local
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*

        echo "âœ… CUDA 13.1 installed successfully"

    - name: Setup CUDA environment
      run: |
        # Add CUDA binaries to PATH
        echo "/usr/local/cuda-13.1/bin" >> $GITHUB_PATH

        # Configure CUDA environment variables
        echo "LD_LIBRARY_PATH=/usr/local/cuda-13.1/lib64:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
        echo "CUDA_HOME=/usr/local/cuda-13.1" >> $GITHUB_ENV
        echo "CUDA_PATH=/usr/local/cuda-13.1" >> $GITHUB_ENV
        echo "CUDACXX=/usr/local/cuda-13.1/bin/nvcc" >> $GITHUB_ENV

        # Create symbolic link for generic CUDA path
        if [ ! -L "/usr/local/cuda" ]; then
          sudo ln -sf /usr/local/cuda-13.1 /usr/local/cuda
        fi

    #==========================================================================
    # OPENSSL 1.1.1 INSTALLATION
    #==========================================================================

    - name: Install OpenSSL 1.1.1
      if: steps.cache-openssl.outputs.cache-hit != 'true'
      run: |
        # Download OpenSSL 1.1.1w (latest 1.1.1 version)
        wget https://www.openssl.org/source/openssl-1.1.1w.tar.gz
        tar -xzf openssl-1.1.1w.tar.gz
        cd openssl-1.1.1w

        # Configure for installation in /usr/local/ssl
        ./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl shared zlib

        # Build with all CPU cores
        make -j$(nproc)

        # Install (no sudo needed as cache handles it)
        sudo make install

        # CLEAN UP OPENSSL FILES
        cd ..
        echo "ðŸ§¹ Cleaning up OpenSSL installation files..."
        sudo rm -rf openssl-1.1.1w openssl-1.1.1w.tar.gz

        echo "âœ… OpenSSL 1.1.1 installed successfully"

    - name: Setup OpenSSL environment
      run: |
        # Add OpenSSL to library path
        echo "LD_LIBRARY_PATH=/usr/local/ssl/lib:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
        echo "OPENSSL_ROOT_DIR=/usr/local/ssl" >> $GITHUB_ENV
        echo "OPENSSL_INCLUDE_DIR=/usr/local/ssl/include" >> $GITHUB_ENV

        # Update dynamic linker cache
        echo "/usr/local/ssl/lib" | sudo tee /etc/ld.so.conf.d/openssl.conf
        sudo ldconfig

    #==========================================================================
    # BOOST 1.86.0 INSTALLATION
    #==========================================================================

    - name: Install Boost 1.86.0
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
        # Download Boost 1.86.0
        wget https://archives.boost.io/release/1.86.0/source/boost_1_86_0.tar.gz
        tar -xzf boost_1_86_0.tar.gz
        cd boost_1_86_0

        # Bootstrap Boost build system
        ./bootstrap.sh --prefix=/usr/local --with-libraries=system,filesystem,thread,chrono,date_time,atomic

        # Build and install static libraries
        sudo ./b2 install \
          --prefix=/usr/local \
          variant=release \
          link=static \
          threading=multi \
          runtime-link=shared \
          cxxflags="-std=c++17" \
          -j$(nproc)

        # CLEAN UP BOOST FILES
        cd ..
        echo "ðŸ§¹ Cleaning up Boost installation files..."
        sudo rm -rf boost_1_86_0 boost_1_86_0.tar.gz

        echo "âœ… Boost 1.86.0 installed successfully"

    #==========================================================================
    # OPENCL 3.0.17 INSTALLATION
    #==========================================================================

    - name: Install OpenCL 3.0.17
      if: steps.cache-opencl.outputs.cache-hit != 'true'
      run: |
        # Clone OpenCL-Headers
        git clone --depth 1 --branch v2024.10.24 https://github.com/KhronosGroup/OpenCL-Headers.git
        cd OpenCL-Headers
        sudo cmake -B build -DCMAKE_INSTALL_PREFIX=/usr/local
        sudo cmake --build build --target install
        cd ..

        # Clone OpenCL-ICD-Loader
        git clone --depth 1 --branch v2024.10.24 https://github.com/KhronosGroup/OpenCL-ICD-Loader.git
        cd OpenCL-ICD-Loader
        sudo cmake -B build \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DOPENCL_ICD_LOADER_HEADERS_DIR=/usr/local/include
        sudo cmake --build build --target install
        cd ..

        # CLEAN UP OPENCL FILES
        echo "ðŸ§¹ Cleaning up OpenCL installation files..."
        sudo rm -rf OpenCL-Headers OpenCL-ICD-Loader

        echo "âœ… OpenCL 3.0.17 installed successfully"

    #==========================================================================
    # VERIFY DEPENDENCIES
    #==========================================================================

    - name: Verify all dependencies
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ” DEPENDENCY VERIFICATION"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # CMake version
        echo "âœ“ CMake: $(cmake --version | head -n1)"

        # CUDA version
        if [ -f "/usr/local/cuda/bin/nvcc" ]; then
          echo "âœ“ CUDA: $(/usr/local/cuda/bin/nvcc --version | grep release | awk '{print $5}' | cut -d',' -f1)"
        else
          echo "âœ— CUDA not found"
          exit 1
        fi

        # OpenSSL version
        if [ -f "/usr/local/ssl/bin/openssl" ]; then
          echo "âœ“ OpenSSL: $(/usr/local/ssl/bin/openssl version)"
        else
          echo "âœ— OpenSSL not found"
          exit 1
        fi

        # Boost version
        if [ -f "/usr/local/include/boost/version.hpp" ]; then
          BOOST_VERSION=$(grep "#define BOOST_LIB_VERSION" /usr/local/include/boost/version.hpp | awk '{print $3}' | tr -d '"')
          echo "âœ“ Boost: ${BOOST_VERSION}"
        else
          echo "âœ— Boost not found"
          exit 1
        fi

        # OpenCL version
        if [ -f "/usr/local/include/CL/cl.h" ]; then
          OPENCL_VERSION=$(grep "#define CL_TARGET_OPENCL_VERSION" /usr/local/include/CL/cl.h | awk '{print $3}')
          echo "âœ“ OpenCL: 3.0.17 (target: ${OPENCL_VERSION})"
        else
          echo "âœ— OpenCL not found"
          exit 1
        fi

        # Clang version
        echo "âœ“ Clang: $(clang-15 --version | head -n1)"

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… All dependencies verified successfully"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    #==========================================================================
    # CMAKE CONFIGURATION
    #==========================================================================

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_NVIDIA=ON \
          -DBUILD_AMD=ON \
          -DBUILD_CPU=ON \
          -DENABLE_LTO=OFF \
          -DENABLE_NATIVE=OFF
      env:
        CUDA_HOME: /usr/local/cuda-13.1
        CUDACXX: /usr/local/cuda-13.1/bin/nvcc
        LD_LIBRARY_PATH: /usr/local/cuda-13.1/lib64:/usr/local/ssl/lib

    #==========================================================================
    # BUILD PROJECT
    #==========================================================================

    - name: Build project
      run: |
        cd build
        # Build with all available CPU cores
        cmake --build . --config Release

    - name: Clean build intermediates
      run: |
        echo "ðŸ§¹ Cleaning up build intermediate files..."
        # Remove CMake temporary files
        find build -type f -name "*.o" -delete
        find build -type f -name "*.a" -delete 2>/dev/null || true
        find build -type d -name "CMakeFiles" -exec rm -rf {} + 2>/dev/null || true
        
        # Keep only final binaries and libraries
        echo "âœ… Build cleanup complete"

    - name: Verify build outputs
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ“¦ BUILD OUTPUTS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # Check build directory structure
        echo "Build directory structure:"
        ls -la build/ || echo "No build directory"

        # Check for binaries in common locations
        if [ -d "build/bin" ]; then
          echo ""
          echo "Binaries in build/bin/:"
          ls -lh build/bin/

          echo ""
          echo "Binary types:"
          for f in build/bin/*; do
            if [ -f "$f" ]; then
              echo "$(basename $f):"
              file "$f"
            fi
          done
        fi

        if [ -d "build/lib" ]; then
          echo ""
          echo "Libraries in build/lib/:"
          ls -lh build/lib/ | head -10
        fi

        if [ -d "bin" ]; then
          echo ""
          echo "Binaries in bin/:"
          ls -lh bin/
        fi

        if [ -d "lib" ]; then
          echo ""
          echo "Libraries in lib/:"
          ls -lh lib/ | head -10
        fi

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    #==========================================================================
    # BUILD SUMMARY
    #==========================================================================

    - name: Build Summary
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… LUMINOUSMINER BUILD COMPLETE"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ“¦ Platform:    Ubuntu 22.04"
        echo "ðŸ“¦ Build Type:  Release"
        echo "ðŸ“¦ CUDA:        13.1 (Blackwell support)"
        echo "ðŸ“¦ Boost:       1.86.0"
        echo "ðŸ“¦ OpenSSL:     1.1.1"
        echo "ðŸ“¦ OpenCL:      3.0.17"
        echo "ðŸ“¦ Compiler:    Clang 15"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # Check all possible artifact locations
        ARTIFACTS_FOUND=false

        if [ -d "build/bin" ] && [ "$(ls -A build/bin 2>/dev/null)" ]; then
          echo "âœ… Build artifacts found in build/bin/"
          ARTIFACTS_FOUND=true
        fi

        if [ -d "bin" ] && [ "$(ls -A bin 2>/dev/null)" ]; then
          echo "âœ… Build artifacts found in bin/"
          ARTIFACTS_FOUND=true
        fi

        if [ "$ARTIFACTS_FOUND" = false ]; then
          echo "âš ï¸  No build artifacts detected (may be normal depending on project structure)"
          echo ""
          echo "ðŸ” Searching for build outputs:"
          find build -name "*.so" -o -name "*.a" -o -type f -executable 2>/dev/null | grep -v ".git" | head -20 || echo "No libraries or executables found"
        else
          echo ""
          echo "âœ… Build completed successfully!"
        fi

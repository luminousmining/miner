name: Build LuminousMiner

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    #==========================================================================
    # INSTALL BASE TOOLS
    #==========================================================================

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libstdc++-12-dev \
          cppcheck \
          checkinstall \
          clang-15 \
          clang++-15 \
          wget \
          git \
          ocl-icd-opencl-dev \
          opencl-headers \
          libgnutls28-dev

    - name: Install CMake 3.26.4
      run: |
        wget https://github.com/Kitware/CMake/releases/download/v3.26.4/cmake-3.26.4-linux-x86_64.sh
        sudo sh cmake-3.26.4-linux-x86_64.sh --skip-license --prefix=/usr/local
        cmake --version

    #==========================================================================
    # CACHE SYSTEM
    #==========================================================================

    - name: Cache CUDA 13.1
      id: cache-cuda
      uses: actions/cache@v4
      with:
        path: /usr/local/cuda-13.1
        key: cuda-13.1-ubuntu-22.04-v2

    - name: Cache OpenSSL 1.1.1
      id: cache-openssl
      uses: actions/cache@v4
      with:
        path: /usr/local/ssl
        key: openssl-1.1.1-ubuntu-22.04-v2

    - name: Cache Boost 1.86.0
      id: cache-boost
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/include/boost
          /usr/local/lib/libboost_*
        key: boost-1.86.0-ubuntu-22.04-static-v2

    - name: Cache OpenCL 3.0.17
      id: cache-opencl
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/include/CL
          /usr/local/lib/libOpenCL.so*
        key: opencl-3.0.17-ubuntu-22.04-v2

    #==========================================================================
    # CUDA 13.1 INSTALLATION
    #==========================================================================

    - name: Install CUDA 13.1
      if: steps.cache-cuda.outputs.cache-hit != 'true'
      run: |
        # Download CUDA repository pin file
        wget --no-check-certificate https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin
        sudo mv cuda-ubuntu2204.pin /etc/apt/preferences.d/cuda-repository-pin-600
        
        # Download CUDA local installer
        wget --no-check-certificate https://developer.download.nvidia.com/compute/cuda/13.1.0/local_installers/cuda-repo-ubuntu2204-13-1-local_13.1.0-530.30.02-1_amd64.deb
        
        # Install CUDA repository
        sudo dpkg -i cuda-repo-ubuntu2204-13-1-local_13.1.0-530.30.02-1_amd64.deb
        sudo cp /var/cuda-repo-ubuntu2204-13-1-local/cuda-*-keyring.gpg /usr/share/keyrings/
        
        # Update and install CUDA toolkit
        sudo apt-get update
        sudo apt-get -y install cuda-toolkit-13-1
        
        echo "âœ… CUDA 13.1 installed successfully"

    - name: Setup CUDA environment
      run: |
        # Add CUDA binaries to PATH
        echo "/usr/local/cuda-13.1/bin" >> $GITHUB_PATH
        
        # Configure CUDA environment variables
        echo "LD_LIBRARY_PATH=/usr/local/cuda-13.1/lib64:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
        echo "CUDA_HOME=/usr/local/cuda-13.1" >> $GITHUB_ENV
        echo "CUDA_PATH=/usr/local/cuda-13.1" >> $GITHUB_ENV
        echo "CUDACXX=/usr/local/cuda-13.1/bin/nvcc" >> $GITHUB_ENV
        
        # Create symbolic link for generic CUDA path
        if [ ! -L "/usr/local/cuda" ]; then
          sudo ln -sf /usr/local/cuda-13.1 /usr/local/cuda
        fi

    #==========================================================================
    # OPENSSL 1.1.1 INSTALLATION
    #==========================================================================

    - name: Install OpenSSL 1.1.1
      if: steps.cache-openssl.outputs.cache-hit != 'true'
      run: |
        # Clone OpenSSL stable branch
        git clone --branch OpenSSL_1_1_1-stable --depth 1 https://github.com/openssl/openssl.git
        cd openssl
        
        # Configure with shared libraries
        ./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl shared
        
        # Build with parallel jobs
        make -j$(nproc)
        
        # Install and update library cache
        sudo make install
        sudo ldconfig
        
        echo "âœ… OpenSSL 1.1.1 installed successfully"

    - name: Verify OpenSSL installation
      run: |
        # Check OpenSSL version
        /usr/local/ssl/bin/openssl version
        
        # List installed libraries
        ls -la /usr/local/ssl/lib/ | grep libssl

    #==========================================================================
    # BOOST 1.86.0 INSTALLATION
    #==========================================================================

    - name: Install Boost 1.86.0
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
        # Download and extract Boost
        wget --no-check-certificate https://archives.boost.io/release/1.86.0/source/boost_1_86_0.tar.gz
        tar -xzf boost_1_86_0.tar.gz
        cd boost_1_86_0
        
        # Bootstrap Boost build system
        ./bootstrap.sh --prefix=/usr/local
        
        # Build and install specific components
        sudo ./b2 install \
          --with-program_options \
          --with-system \
          --with-thread \
          --with-filesystem \
          --with-chrono \
          --with-atomic \
          link=static \
          threading=multi \
          runtime-link=shared \
          variant=release \
          -j$(nproc)
        
        echo "âœ… Boost 1.86.0 installed successfully"

    - name: Verify Boost installation
      run: |
        # List installed Boost libraries
        ls -la /usr/local/lib/libboost_* | head -5
        echo "Boost libraries installed"

    #==========================================================================
    # OPENCL 3.0.17 INSTALLATION
    #==========================================================================

    - name: Install OpenCL 3.0.17
      if: steps.cache-opencl.outputs.cache-hit != 'true'
      run: |
        # Install OpenCL Headers
        git clone --depth 1 --branch v2024.10.24 https://github.com/KhronosGroup/OpenCL-Headers.git
        cd OpenCL-Headers
        sudo cp -r CL /usr/local/include/
        cd ..
        
        # Install OpenCL ICD Loader
        git clone --depth 1 --branch v2024.10.24 https://github.com/KhronosGroup/OpenCL-ICD-Loader.git
        cd OpenCL-ICD-Loader
        mkdir build && cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
        make -j$(nproc)
        sudo make install
        sudo ldconfig
        
        echo "âœ… OpenCL 3.0.17 installed successfully"

    - name: Verify OpenCL installation
      run: |
        # Check OpenCL headers
        ls -la /usr/local/include/CL/
        
        # Check OpenCL libraries
        ls -la /usr/local/lib/libOpenCL.so*

    #==========================================================================
    # VERIFY ALL DEPENDENCIES
    #==========================================================================

    - name: Verify all installations
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” DEPENDENCY VERSIONS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        echo "ğŸ“¦ CMake:"
        cmake --version | head -1
        
        echo ""
        echo "ğŸ“¦ CUDA:"
        nvcc --version | grep release
        
        echo ""
        echo "ğŸ“¦ OpenSSL:"
        /usr/local/ssl/bin/openssl version
        
        echo ""
        echo "ğŸ“¦ Boost:"
        ls /usr/local/lib/libboost_system.* | head -1
        
        echo ""
        echo "ğŸ“¦ OpenCL:"
        ls /usr/local/include/CL/cl.h
        
        echo ""
        echo "ğŸ“¦ Clang:"
        clang-15 --version | head -1
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    #==========================================================================
    # CMAKE CONFIGURATION
    #==========================================================================

    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        
        # Configure project with all dependencies
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_AMD=ON \
          -DBUILD_CPU=ON \
          -DBUILD_NVIDIA=ON \
          -DENABLE_LTO=OFF
      env:
        CUDA_HOME: /usr/local/cuda-13.1
        CUDACXX: /usr/local/cuda-13.1/bin/nvcc
        LD_LIBRARY_PATH: /usr/local/cuda-13.1/lib64:/usr/local/ssl/lib

    #==========================================================================
    # BUILD PROJECT
    #==========================================================================

    - name: Build project
      run: |
        cd build
        # Build with all available CPU cores
        cmake --build . --config Release -j$(nproc)

    - name: Verify build outputs
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ BUILD OUTPUTS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        echo "Binaries:"
        ls -lh bin/ || echo "No binaries found"
        
        echo ""
        echo "Libraries:"
        ls -lh lib/ || echo "No libraries found"
        
        echo ""
        echo "Binary types:"
        for f in bin/*; do
          if [ -f "$f" ]; then
            echo "$(basename $f):"
            file "$f"
          fi
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    #==========================================================================
    # UPLOAD ARTIFACTS
    #==========================================================================

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: luminousminer-linux-cuda13.1-release
        path: |
          bin/
          lib/
        retention-days: 7
        if-no-files-found: warn

    - name: Upload binaries only
      uses: actions/upload-artifact@v4
      with:
        name: luminousminer-binaries-release
        path: bin/*
        retention-days: 30
        if-no-files-found: error

    #==========================================================================
    # BUILD SUMMARY
    #==========================================================================

    - name: Build Summary
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… LUMINOUSMINER BUILD COMPLETE"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ Platform:    Ubuntu 22.04"
        echo "ğŸ“¦ Build Type:  Release"
        echo "ğŸ“¦ CUDA:        13.1 (Blackwell support)"
        echo "ğŸ“¦ Boost:       1.86.0"
        echo "ğŸ“¦ OpenSSL:     1.1.1"
        echo "ğŸ“¦ OpenCL:      3.0.17"
        echo "ğŸ“¦ Compiler:    Clang 15"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Check if build artifacts exist
        if [ -d "bin" ]; then
          echo "âœ… Build artifacts available"
        else
          echo "âŒ Build artifacts missing"
          exit 1
        fi

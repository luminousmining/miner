name: Linux OpenCL

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ===============================
      # Restore OpenCL cache
      # ===============================
      - name: Restore OpenCL cache
        id: opencl-cache
        uses: actions/cache@v4
        with:
          path: opencl-install
          key: opencl-${{ runner.os }}-1.1.1w

      # ===============================
      # Install build dependencies
      # ===============================
      - name: Install build dependencies
        if: steps.openssl-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update

      # ===============================
      # Build OpenCL 3.0.19
      # ===============================
      - name: Build OpenCL 3.0.19
        if: steps.opencl-cache.outputs.cache-hit != 'true'
        run: |
          echo "üì• Cloning OpenCL-SDK..."
          git clone --depth 1 https://github.com/KhronosGroup/OpenCL-SDK.git
          cd OpenCL-SDK

          echo "üîÑ Fetching tags..."
          git fetch --all --tags
          git checkout tags/v2025.07.23

          echo "üì¶ Initializing submodules..."
          git submodule init
          git submodule update

          echo "üèóÔ∏è Configuring OpenCL-SDK build..."
          mkdir build
          cd build

          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_TESTS=OFF \
            -DOPENCL_SDK_BUILD_SAMPLES=OFF \
            -DOPENCL_SDK_TEST_SAMPLES=OFF \
            -DCMAKE_INSTALL_PREFIX=/usr/local \

          echo "üî® Building and installing OpenCL-SDK..."
          sudo cmake --build . --target install

          cd ../..

          echo "üßπ Cleaning up OpenCL-SDK sources..."
          sudo rm -rf OpenCL-SDK

          echo "‚úÖ OpenCL SDK 3.0.19 installed successfully"

      # ===============================
      # Upload artifact
      # ===============================
      - name: Upload OpenCL artifact
        if: steps.opencl-cache.outputs.cache-hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: opencl-${{ runner.os }}-1.1.1w
          path: opencl-install

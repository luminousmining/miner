name: Linux OpenSSL

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ===============================
      # Restore OpenSSL cache
      # ===============================
      - name: Restore OpenSSL cache
        id: openssl-cache
        uses: actions/cache@v4
        with:
          path: openssl-install
          key: openssl-${{ runner.os }}-1.1.1w

      # ===============================
      # Install build dependencies
      # ===============================
      - name: Install build dependencies
        if: steps.openssl-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential perl wget

      # ===============================
      # Build OpenSSL 1.1.1w
      # ===============================
      - name: Build OpenSSL 1.1.1w
        if: steps.openssl-cache.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/openssl/openssl.git
          cd openssl

          git fetch --all
          git checkout tags/OpenSSL_1_1_1w

          ./Configure linux-x86_64 \
            --prefix=${{ github.workspace }}/openssl-install \
            --openssldir=${{ github.workspace }}/openssl-install

          make -j$(nproc)
          make install_sw

          cd ..
          rm -rf openssl

          echo "âœ… OpenSSL 1.1.1w built successfully"

      # ===============================
      # Upload artifact
      # ===============================
      - name: Upload OpenSSL artifact
        if: steps.openssl-cache.outputs.cache-hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: openssl-${{ runner.os }}-1.1.1w
          path: openssl-install
